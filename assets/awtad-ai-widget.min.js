/* --- Awtad AI Widget (v4 - Floating Dropdown Results) --- */
(function(){
  const ENDPOINT = (document.currentScript?.dataset?.endpoint) || "https://<your-worker>.workers.dev/api/policies-ai";
  const SEARCH_SELECTOR = ".ai-search-input, input[placeholder*='Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰']";

  let isFetching = false; // Ù„Ù…Ù†Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©

  // --- 1. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ù…Ø§Ø· (Styles) ---
  // ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…Ø®Ø±Ø¬ Ø§Ù„Ø¹Ø§Ø¦Ù…
  function ensureStyles(){
    if(document.getElementById("awtad-ai-styles")) return;
    const s=document.createElement("style");
    s.id="awtad-ai-styles";
    s.textContent=`
      #awtad-ai-btn { display: none !important; } /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… */
      
      .ai-search-wrapper { 
        position: relative; /* Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡ */
      }
      
      /* [Ù…Ø¹Ø¯Ù„] ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ù„ÙŠØ¨Ø¯Ùˆ Ù…ØªØµÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© */
      .ai-search-input { 
        padding-left: 56px !important; 
        border-color: #cbd5e1;
        position: relative; /* Ù„Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¦Ù‡ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        z-index: 101; /* Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        transition: border-radius 0.3s ease;
      }
      .ai-search-input.open {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }

      .ai-search-btn { 
        position: absolute; left: 6px; top: 50%; transform: translateY(-50%); 
        width: 40px; height: 40px; background: #1f2937; 
        border: none; border-radius: 8px; cursor: pointer; 
        display: flex; align-items: center; justify-content: center;
        transition: background-color 0.2s;
        z-index: 102; /* Ø£Ø¹Ù„Ù‰ Ù…Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« */
      }
      .ai-search-btn:hover { background: #374151; }
      .ai-search-btn:disabled { background: #94a3b8; cursor: not-allowed; }
      .ai-search-btn svg { fill: none; stroke: white; stroke-width: 2; }

      /* --- [Ø¬Ø¯ÙŠØ¯] Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø®Ø±Ø¬ Ø§Ù„Ø¹Ø§Ø¦Ù… (Floating Dropdown) --- */
      .ai-inline-output {
        position: absolute; /* [Ù…Ù‡Ù…] ÙŠØ¬Ø¹Ù„Ù‡Ø§ Ø¹Ø§Ø¦Ù…Ø© */
        top: 100%; /* ØªØ¨Ø¯Ø£ Ù…Ù† Ø£Ø³ÙÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
        left: 0;
        right: 0;
        z-index: 100; /* [Ù…Ù‡Ù…] ØªØ·ÙÙˆ ÙÙˆÙ‚ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
        
        background: #ffffff; /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ ØµÙ„Ø¨Ø© */
        border: 1px solid #e5e7eb; /* Ø­Ø¯ÙˆØ¯ Ø¸Ø§Ù‡Ø±Ø© */
        border-top: none; /* Ù„Ø¥Ù„ØµØ§Ù‚Ù‡Ø§ Ø¨ØµØ±ÙŠØ§Ù‹ Ø¨Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« */
        border-radius: 0 0 8px 8px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1); /* Ø¸Ù„ Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø¹Ù…Ù‚ */

        max-height: 0; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        padding: 0 1.25rem; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ø´Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
        overflow: hidden; /* Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
        transition: max-height 0.4s ease-out, padding 0.3s ease;
      }
      
      /* Ø­Ø§Ù„Ø© "Ù…ÙØªÙˆØ­" Ù„Ù„ØªØ­Ø±ÙŠÙƒ */
      .ai-inline-output.open {
        padding: 1.25rem;
        max-height: 60vh; /* [Ù…Ù‡Ù…] "Ø·ÙˆÙŠÙ„ Ù„Ù„Ø§Ø³ÙÙ„" Ù…Ø¹ Ø­Ø¯ Ø£Ù‚ØµÙ‰ */
        overflow-y: auto; /* [Ù…Ù‡Ù…] Ø¥Ø¶Ø§ÙØ© Ø³ÙƒØ±ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø·ÙˆÙŠÙ„Ø§Ù‹ */
      }
      
      .ai-inline-output.loading {
        color: #4b5563;
        font-style: italic;
        padding: 1.25rem; /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø´Ùˆ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
      }
      .ai-inline-output.error {
        color: #b91c1c;
        background: #fef2f2;
        border-color: #fecaca;
        padding: 1.25rem; /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø´Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£ */
      }

      /* (Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ù†Ø³Ø® ÙƒÙ…Ø§ Ù‡ÙŠ) */
      .ai-inline-output .policy-content { all:revert; margin: 1em 0; }
      .ai-inline-output .policy-content * { all:revert; }
      .ai-inline-output .policy-content h4 { font-weight:bold; margin-top:1em; margin-bottom:0.5em; }
      .ai-inline-output .policy-content ul { list-style-type:disc; margin-right:1.5em; }
      .ai-inline-output .copy-btn {
        position:absolute; top:8px; left:8px; 
        background:rgba(230,230,230,0.8); border:1px solid #ccc; 
        border-radius:4px; cursor:pointer; opacity:0.3; transition:opacity .2s;
        font-size: 12px; padding: 2px 5px; z-index: 101;
      }
      .ai-inline-output:hover .copy-btn { opacity:1; }
    `;
    document.head.appendChild(s);
  }

  // --- 2. Ø¬Ù„Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Helper) ---
  function collectPolicyUrls() {
      const base = location.origin.replace(/\/$/, '');
      const anchors = Array.from(document.querySelectorAll('[data-file]'));
      const urls = anchors
          .map(a => a.getAttribute('data-file'))
          .filter(Boolean)
          .map(f => `${base}/policies/${f}.html`);
      return Array.from(new Set(urls));
  }
  
  // --- 3. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù†Ø³Ø® (Helper) ---
  function copyResponse(btn) {
      const outputContainer = btn.closest('.ai-inline-output');
      const txt = outputContainer.innerText.replace(btn.innerText, "").trim();
      navigator.clipboard.writeText(txt).then(() => {
          const old=btn.innerText; btn.innerText="âœ” ØªÙ… Ø§Ù„Ù†Ø³Ø®"; setTimeout(()=>btn.innerText=old, 1500);
      }, () => {
          const old=btn.innerText; btn.innerText="âŒ ÙØ´Ù„"; setTimeout(()=>btn.innerText=old, 1500);
      });
  }

  // --- 4. [Ù…Ø¹Ø¯Ù„] Ù…Ù†Ø·Ù‚ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø®Ø±Ø¬ Ø§Ù„Ø¹Ø§Ø¦Ù… ---
  async function handleSend(inputText, outputContainer, sendButton, searchInput) {
      if (isFetching) return;
      isFetching = true;
      if(sendButton) sendButton.disabled = true;
      if(searchInput) searchInput.classList.add('open'); // Ù„ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«

      // Ø£. Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      outputContainer.innerHTML = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦';
      outputContainer.className = 'ai-inline-output open loading';
      // [Ù…Ø¹Ø¯Ù„] ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ù„Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø§Ù†Ø³ÙŠØ§Ø¨ÙŠ
      outputContainer.style.maxHeight = '60vh';

      try {
        const payload = { 
          action: "auto", 
          text: inputText.slice(0, 8000),
          question: inputText.slice(0, 8000),
          page: location.pathname,
          urls: collectPolicyUrls()
        };
        
        const r = await fetch(ENDPOINT, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
        if(!r.ok) throw new Error(`Network error ${r.status}`);
        const j = await r.json();
        if(j.error) throw new Error(j.message || j.error);
        
        let html = (j.result ?? j.html ?? j.text ?? "").toString();
        
        // Ø¨. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        outputContainer.className = 'ai-inline-output open'; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        if ((j.detected === "author") || (html.startsWith("<") && !html.includes("ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±"))) {
           if(!/class=["']policy-content["']/.test(html)){ html = `<div class="policy-content">${html}</div>`; } 
           outputContainer.innerHTML = `<button class="copy-btn" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>` + html;
        } else {
           const txt = html.replace(/\n/g,'<br>'); 
           outputContainer.innerHTML = `<button class="copy-btn" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>` + txt;
        }
        
        outputContainer.querySelector('.copy-btn').onclick = (e) => copyResponse(e.target);
        // [Ù…Ø¹Ø¯Ù„] Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù‡Ùˆ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
        outputContainer.style.maxHeight = '60vh';
        
      } catch(e) {
        // Ø¬. Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£
        outputContainer.className = 'ai-inline-output open error';
        outputContainer.innerHTML = `ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯. ${e.message}`;
        outputContainer.style.maxHeight = '60vh'; // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
        console.error(e);
      } finally {
        isFetching = false;
        if(sendButton) sendButton.disabled = false;
      }
  }

  // --- 5. [Ù…Ø¹Ø¯Ù„] ØªØ¹Ø²ÙŠØ² Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« ---
  function enhanceSearchBox(input) {
    if (input.dataset.aiEnhanced) return;
    input.dataset.aiEnhanced = 'true';

    let wrapper = input.parentElement;
    if (!wrapper.classList.contains('ai-search-wrapper')) {
        wrapper = document.createElement('div');
        wrapper.className = 'ai-search-wrapper';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);
    }

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "ai-search-btn";
    btn.title = "Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ";
    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
    wrapper.appendChild(btn);

    const outputContainer = document.createElement("div");
    outputContainer.className = "ai-inline-output";
    wrapper.appendChild(outputContainer);

    const triggerAI = () => {
        const text = input.value.trim();
        if (!text || isFetching) return;
        
        // [Ù…Ø¹Ø¯Ù„] ØªÙ…Ø±ÙŠØ± Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ù†ÙØ³Ù‡ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø´ÙƒÙ„Ù‡
        handleSend(text, outputContainer, btn, input);
    };

    btn.addEventListener("click", triggerAI);
    input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            triggerAI();
        }
    });
    
    // [Ù…Ø¹Ø¯Ù„] Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©
    input.addEventListener("input", () => {
        if (outputContainer.style.maxHeight !== '0px') {
            outputContainer.style.maxHeight = '0';
            outputContainer.classList.remove('open', 'loading', 'error');
            input.classList.remove('open'); // Ø¥Ø¹Ø§Ø¯Ø© Ø´ÙƒÙ„ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«
        }
    });
    
    // [Ø¬Ø¯ÙŠØ¯] Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target) && outputContainer.style.maxHeight !== '0px') {
            outputContainer.style.maxHeight = '0';
            outputContainer.classList.remove('open', 'loading', 'error');
            input.classList.remove('open');
        }
    });
  }

  // --- 6. [ÙƒÙ…Ø§ Ù‡Ùˆ] ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ù„Ø±Ø¨Ø·Ù‡Ø§ ---
  function initAIIntegration() {
    ensureStyles(); // ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ù‚Ù† Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©

    const findAndEnhance = () => {
        document.querySelectorAll(SEARCH_SELECTOR).forEach(input => {
            if (!input.dataset.aiEnhanced) {
                enhanceSearchBox(input);
            }
        });
    };

    findAndEnhance(); // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ø±Ø¨Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹

    const mainContent = document.getElementById("content") || document.body;
    const observer = new MutationObserver(findAndEnhance);
    observer.observe(mainContent, { childList: true, subtree: true });
  }

  // --- 7. [ÙƒÙ…Ø§ Ù‡Ùˆ] Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ---
  if (document.readyState === "complete") {
    initAIIntegration();
  } else {
    window.addEventListener("load", initAIIntegration);
  }
})();